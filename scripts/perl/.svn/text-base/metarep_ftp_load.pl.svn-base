##################################################################
# Description: metarep_ftp_put.pl
# --------------
# Author: jgoll 
# Email:  jgoll@jcvi.org
# Date:   May 14, 2010  
##################################################################

BEGIN {
   unshift(@INC, '/local/annotation_metagenomic/METAREP/parser/lib');
  #unshift(@INC, '/export/projects/metagenomics-reports/parsers/solr/lib');
}
use MetarepDAO;
use strict;
use Net::FTP;

my $projectId = $ARGV[0];
#my $tmp = '/usr/local/annotation/METAGENOMIC/METAREP/ftp';
my $tmp = '/usr/local/scratch/jgoll/ftp';


#$ftp->rmdir($projectId,1);

my $metarepDao = MetarepDAO->new();
my %paths = $metarepDao->getPathsByProject($projectId);

my $tmpProject = $tmp .="-$projectId";

`rm -rf $tmpProject`;

`mkdir $tmpProject`;

`cd $tmpProject`;

#ftp actions
my $ftp = Net::FTP->new("ftp.jcvi.org", Debug => 0)
      or die "Cannot connect to some.host.name: $@";
      
$ftp->login("metarep",'k54raCRepene')
      or print "Cannot login $ftp->message";

$ftp->mkdir($projectId) or print "Cannot create directory $projectId  $ftp->message \n";
	            

foreach my $library ( keys %paths) {	

	my $libraryPath = $paths{$library};

	#ausoil fix
	$libraryPath =~ s/\/local\/closure2_flex/\/usr\/local\/archive\/projects/;
	
	#unless(-e "$tmpProject/$library.tgz") {	
		
	#gzip all source files	
	print "gzip -r $paths{$library} \n";
	`gzip -r $paths{$library}`;

	`mkdir $tmpProject/$library`;
		
	#copy readme
	print "/usr/bin/rsync /usr/local/annotation/METAGENOMIC/METAREP/readme.pdf $tmpProject/$library \n";
	`/usr/bin/rsync /usr/local/annotation/METAGENOMIC/METAREP/readme.pdf $tmpProject/$library`;		

	#read file
	`/usr/bin/rsync $paths{$library}/orf-calling/input/*.fasta.gz $tmpProject/$library/read.fasta.gz`;
	#rrna file
	`/usr/bin/rsync $paths{$library}/orf-calling/camera_rrna_finder.combined.fasta.gz $tmpProject/$library/rrna.fasta.gz`;
	#trna file
	`/usr/bin/rsync $paths{$library}/orf-calling/camera_extract_trna.combined.fasta.gz $tmpProject/$library/trna.fasta.gz`;	
	#peptide file
	`/usr/bin/rsync $paths{$library}/orf-calling/metagene_mapped_pep.fasta.gz $tmpProject/$library/peptide.fasta.gz`;		
	#blastp tab
	`/usr/bin/rsync $paths{$library}/annotation/ncbi_blastp_btab.combined.out.gz $tmpProject/$library/blast.tab.gz`;		
	#hmm tab
	`/usr/bin/rsync $paths{$library}/annotation/ldhmmpfam_full.htab.combined.out.gz $tmpProject/$library/hmm.tab.gz`;
	#annotation tab
	`/usr/bin/rsync $paths{$library}/annotation/annotation_rules.combined.out.gz $tmpProject/$library/annotation.tab.gz`;			
	
	#grant permissions
	`chmod 777 $tmpProject/$library/*`;
	
	#create tar	
	print "cd $tmpProject/$library; tar cvzf $tmpProject/$library.tgz *";
	system("cd $tmpProject/$library; tar cvzf $tmpProject/$library.tgz *");

	$ftp->login("metarep",'k54raCRepene')
	      or print "Cannot login $ftp->message";
	
	$ftp->cwd($projectId) or print "Cannot change directory $ftp->message \n";

	#clean up old files
	print "ftp delete(\"$library.tgz\"\")\n";
	$ftp->delete("$library.tgz") or print "Cannot delete $library.tgz  $ftp->message \n";

	#login again (times out)
	print "ftp login \n";
	$ftp->login("metarep",'k54raCRepene')  or print "Cannot login $ftp->message \n";
	
	#switch to ftp binary mode
	print "ftp binary \n";
	$ftp->binary() or print "Cannot switch to binary mode $ftp->message \n";;
	
	#copy files to ftp area
	print "ftp put(\"$tmpProject/$library.tgz\")\n";
	$ftp->put("$tmpProject/$library.tgz")  or print "Cannot put $tmpProject/$library.tgz $ftp->message \n";
	
	#clean up
	`rm -rf $tmpProject/$library`;
	#`rm $tmpProject/$library.tgz`;
	#}
	#set database flag
	$metarepDao->setFtpFlag($library);
}

my $allFile = $projectId."_all.tgz";

#create tar of tar	
print "cd $tmpProject; tar cvzf $tmpProject/$allFile *";
system("cd $tmpProject; tar cvzf $tmpProject/$allFile *");

#login again (times out)
print "ftp login \n";
$ftp->login("metarep",'k54raCRepene')  or print "Cannot login $ftp->message \n";

#copy file to ftp area
print "ftp put(\"$tmpProject/$allFile\")\n";
$ftp->put("$tmpProject/$allFile")  or print "Cannot put $tmpProject/$allFile $ftp->message \n";







